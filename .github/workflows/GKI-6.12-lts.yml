name: GKI 6.12 LTS Build

on:
  workflow_dispatch:
    inputs:
      arch:
        description: 'Target architecture'
        required: true
        default: 'arm64'
        type: choice
        options:
          - arm64
          - x86_64
          - riscv64
      build_lto:
        description: 'LTO configuration'
        required: false
        default: 'default'
        type: choice
        options:
          - default
          - thin
          - full
          - none
      upload_to_release:
        description: 'Upload to Release'
        required: false
        default: false
        type: boolean

env:
  TARGET_ARCH: ${{ github.event.inputs.arch || 'arm64' }}
  LTO_CONFIG: ${{ github.event.inputs.build_lto || 'default' }}

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Free disk space
        run: |
          echo "=== 清理磁盘空间 ==="
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android/sdk /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/*
          sudo rm -rf /opt/microsoft /opt/pipx /opt/google /opt/az
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt-get remove -y \
            azure-cli google-chrome-stable firefox microsoft-edge-stable \
            powershell temurin-*-jdk dotnet-sdk-* mono-complete \
            2>/dev/null || true
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential bc bison flex libelf-dev libssl-dev \
            libncurses-dev llvm clang lld git cpio python3 file zstd

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: gki-6.12-${{ env.TARGET_ARCH }}
          max-size: 2G

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install repo tool
        run: |
          mkdir -p ~/bin
          curl -sSL https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH
          git config --global user.name "CI" && git config --global user.email "ci@localhost"

      - name: Sync kernel source
        run: |
          echo "=== 初始化仓库 ==="
          mkdir gki && cd gki
          
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b common-android16-6.12-lts \
            --depth=1
          
          echo "=== 同步源码 ==="
          repo sync -j$(nproc) -c --no-tags --no-clone-bundle
          
          echo "=== 检查关键目录 ==="
          ls -la
          test -d common || { echo "错误: common 目录不存在"; exit 1; }
          test -d build/kernel || { echo "错误: build/kernel 目录不存在"; exit 1; }
          test -f tools/bazel || { echo "错误: tools/bazel 不存在"; exit 1; }
          
          df -h

      - name: List available targets
        run: |
          cd gki
          echo "=== 查看可用的编译目标 ==="
          ls -la common/BUILD.bazel 2>/dev/null || echo "common/BUILD.bazel 不存在"
          
          # 检查 common 目录中的目标
          if [ -f "common/BUILD.bazel" ]; then
            echo "=== common 目录目标 ==="
            grep -E "^(kernel_|name =)" common/BUILD.bazel | head -30 || true
          fi
          
          # 尝试查询目标
          ./tools/bazel query "//common:*" 2>/dev/null | grep -E "kernel_" | head -20 || true

      - name: Build GKI kernel
        id: build_kernel
        run: |
          cd gki
          
          case "${{ env.TARGET_ARCH }}" in
            arm64)   KERNEL_TARGET="kernel_aarch64" ;;
            x86_64)  KERNEL_TARGET="kernel_x86_64" ;;
            riscv64) KERNEL_TARGET="kernel_riscv64" ;;
          esac
          
          LTO_FLAGS=""
          case "${{ env.LTO_CONFIG }}" in
            thin) LTO_FLAGS="--lto=thin" ;;
            full) LTO_FLAGS="--lto=full" ;;
            none) LTO_FLAGS="--lto=none" ;;
          esac
          
          echo "=== 编译 //common:$KERNEL_TARGET ==="
          echo "kernel_target=$KERNEL_TARGET" >> $GITHUB_OUTPUT
          
          set -o pipefail
          ./tools/bazel build //common:$KERNEL_TARGET $LTO_FLAGS \
            --jobs=$(nproc) 2>&1 | tee build.log
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "::error::Bazel 编译失败，退出码: $BUILD_EXIT_CODE"
            tail -100 build.log
            exit $BUILD_EXIT_CODE
          fi
          
          echo "=== 编译成功 ==="

      - name: Build distribution
        id: build_dist
        run: |
          cd gki
          
          KERNEL_TARGET="${{ steps.build_kernel.outputs.kernel_target }}"
          echo "=== 生成分发包: //common:${KERNEL_TARGET}_dist ==="
          
          set -o pipefail
          ./tools/bazel run //common:${KERNEL_TARGET}_dist 2>&1 | tee dist.log
          
          DIST_EXIT_CODE=${PIPESTATUS[0]}
          if [ $DIST_EXIT_CODE -ne 0 ]; then
            echo "::error::生成分发包失败，退出码: $DIST_EXIT_CODE"
            tail -100 dist.log
            exit $DIST_EXIT_CODE
          fi
          
          echo "=== 分发包生成成功 ==="

      - name: Prepare artifacts
        run: |
          cd gki
          
          KERNEL_TARGET="${{ steps.build_kernel.outputs.kernel_target }}"
          
          case "${{ env.TARGET_ARCH }}" in
            arm64)   IMAGE="Image" ;;
            x86_64)  IMAGE="bzImage" ;;
            riscv64) IMAGE="Image" ;;
          esac
          
          mkdir -p output
          
          echo "=== 查找输出目录 ==="
          find out -type d -name "dist" 2>/dev/null || true
          find . -path "./out/*" -name "*.img" 2>/dev/null | head -20 || true
          
          # 从多个可能的位置复制
          for DIST_DIR in "out/$KERNEL_TARGET/dist" "out/dist" "out/common/$KERNEL_TARGET/dist"; do
            if [ -d "$DIST_DIR" ]; then
              echo "从 $DIST_DIR 复制文件"
              cp -v $DIST_DIR/$IMAGE output/ 2>/dev/null || true
              cp -v $DIST_DIR/*.img output/ 2>/dev/null || true
              cp -v $DIST_DIR/*.ko output/ 2>/dev/null || true
              cp -v $DIST_DIR/vmlinux output/ 2>/dev/null || true
            fi
          done
          
          # 备用：从 bazel-out 查找
          if [ ! -f "output/$IMAGE" ]; then
            echo "从 bazel-out 查找内核镜像..."
            find bazel-out -name "$IMAGE" -exec cp -v {} output/ \; 2>/dev/null || true
          fi
          
          # 备用：从 out 查找所有 img 文件
          find out -name "*.img" -exec cp -v {} output/ \; 2>/dev/null || true
          
          cp build.log output/ 2>/dev/null || true
          cp dist.log output/ 2>/dev/null || true
          
          # 检查输出
          echo "=== 输出文件 ==="
          ls -la output/
          
          # 验证关键文件
          TOTAL_SIZE=$(du -sb output/ | cut -f1)
          if [ $TOTAL_SIZE -lt 10000 ]; then
            echo "::error::输出文件太小 ($TOTAL_SIZE bytes)，编译可能失败"
            exit 1
          fi
          
          if [ ! -f "output/$IMAGE" ]; then
            echo "::warning::未找到内核镜像 $IMAGE"
          fi
          
          # 生成信息
          echo "GKI 6.12 LTS - ${{ env.TARGET_ARCH }}" > output/build_info.txt
          echo "Build: ${{ github.run_number }}" >> output/build_info.txt
          echo "Date: $(date)" >> output/build_info.txt
          echo "Size: $TOTAL_SIZE bytes" >> output/build_info.txt
          
          # 清理源码释放空间
          echo "=== 清理源码 ==="
          rm -rf common build/kernel prebuilts/clang 2>/dev/null || true
          df -h

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gki-6.12-${{ env.TARGET_ARCH }}
          path: gki/output/
          retention-days: 7
          compression-level: 9

      - name: Create release
        if: ${{ github.event.inputs.upload_to_release == 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: gki-6.12-${{ env.TARGET_ARCH }}-${{ github.run_number }}
          name: GKI 6.12 ${{ env.TARGET_ARCH }} #${{ github.run_number }}
          body_path: gki/output/build_info.txt
          files: gki/output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post build summary
        run: |
          echo "## GKI 构建完成 ✅" >> $GITHUB_STEP_SUMMARY
          echo "架构: ${{ env.TARGET_ARCH }} | LTO: ${{ env.LTO_CONFIG }}" >> $GITHUB_STEP_SUMMARY