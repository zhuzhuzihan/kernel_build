name: GKI 6.12 LTS Build

on:
  workflow_dispatch:
    inputs:
      arch:
        description: 'Target architecture'
        required: true
        default: 'arm64'
        type: choice
        options:
          - arm64
          - x86_64
          - riscv64
      build_lto:
        description: 'LTO configuration'
        required: false
        default: 'default'
        type: choice
        options:
          - default
          - thin
          - full
          - none
      upload_to_release:
        description: 'Upload to Release'
        required: false
        default: false
        type: boolean

env:
  TARGET_ARCH: ${{ github.event.inputs.arch || 'arm64' }}
  LTO_CONFIG: ${{ github.event.inputs.build_lto || 'default' }}

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Free disk space
        run: |
          echo "=== 清理磁盘空间 ==="
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android/sdk /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/*
          sudo rm -rf /opt/microsoft /opt/pipx /opt/google /opt/az
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt-get remove -y \
            azure-cli google-chrome-stable firefox microsoft-edge-stable \
            powershell temurin-*-jdk dotnet-sdk-* mono-complete \
            2>/dev/null || true
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential bc bison flex libelf-dev libssl-dev \
            libncurses-dev llvm clang lld git cpio python3 file zstd

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: gki-6.12-${{ env.TARGET_ARCH }}
          max-size: 2G

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install repo tool
        run: |
          mkdir -p ~/bin
          curl -sSL https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH
          git config --global user.name "CI" && git config --global user.email "ci@localhost"

      - name: Sync kernel source
        run: |
          echo "=== 初始化仓库 ==="
          mkdir gki && cd gki
          
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b common-android16-6.12-lts \
            --depth=1 \
            --partial-clone --clone-filter=blob:limit=10M
          
          echo "=== 同步必要源码 ==="
          # 只同步编译所需的核心项目
          repo sync -j$(nproc) -c --no-tags --no-clone-bundle \
            kernel/build kernel/common \
            prebuilts/clang/host/linux-x86 \
            prebuilts/build-tools \
            prebuilts/kernel-build-tools
          
          df -h

      - name: Build GKI kernel
        run: |
          cd gki
          
          case "${{ env.TARGET_ARCH }}" in
            arm64)   KERNEL_TARGET="kernel_aarch64" ;;
            x86_64)  KERNEL_TARGET="kernel_x86_64" ;;
            riscv64) KERNEL_TARGET="kernel_riscv64" ;;
          esac
          
          LTO_FLAGS=""
          case "${{ env.LTO_CONFIG }}" in
            thin) LTO_FLAGS="--lto=thin" ;;
            full) LTO_FLAGS="--lto=full" ;;
            none) LTO_FLAGS="--lto=none" ;;
          esac
          
          echo "=== 编译 $KERNEL_TARGET ==="
          ./tools/bazel build //$KERNEL_TARGET $LTO_FLAGS \
            --config=fast --jobs=$(nproc) 2>&1 | tee build.log

      - name: Build distribution
        run: |
          cd gki
          
          case "${{ env.TARGET_ARCH }}" in
            arm64)   KERNEL_TARGET="kernel_aarch64" ;;
            x86_64)  KERNEL_TARGET="kernel_x86_64" ;;
            riscv64) KERNEL_TARGET="kernel_riscv64" ;;
          esac
          
          echo "=== 生成分发包 ==="
          ./tools/bazel run //$KERNEL_TARGET_dist 2>&1 | tee dist.log

      - name: Prepare artifacts
        run: |
          cd gki
          
          case "${{ env.TARGET_ARCH }}" in
            arm64)   KERNEL_TARGET="kernel_aarch64"; IMAGE="Image" ;;
            x86_64)  KERNEL_TARGET="kernel_x86_64"; IMAGE="bzImage" ;;
            riscv64) KERNEL_TARGET="kernel_riscv64"; IMAGE="Image" ;;
          esac
          
          mkdir -p output
          
          # 只复制关键文件
          find out/$KERNEL_TARGET/dist -maxdepth 1 -type f \
            \( -name "$IMAGE" -o -name "*.img" -o -name "*.ko" \) \
            -exec cp {} output/ \; 2>/dev/null || true
          
          cp build.log output/ 2>/dev/null || true
          
          # 生成信息
          echo "GKI 6.12 LTS - ${{ env.TARGET_ARCH }}" > output/build_info.txt
          echo "Build: ${{ github.run_number }}" >> output/build_info.txt
          echo "Date: $(date)" >> output/build_info.txt
          
          # 清理源码释放空间
          echo "=== 清理源码 ==="
          rm -rf common build/kernel prebuilts/clang 2>/dev/null || true
          df -h
          
          ls -la output/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gki-6.12-${{ env.TARGET_ARCH }}
          path: gki/output/
          retention-days: 7
          compression-level: 9

      - name: Create release
        if: ${{ github.event.inputs.upload_to_release == 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: gki-6.12-${{ env.TARGET_ARCH }}-${{ github.run_number }}
          name: GKI 6.12 ${{ env.TARGET_ARCH }} #${{ github.run_number }}
          body_path: gki/output/build_info.txt
          files: gki/output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post build summary
        run: |
          echo "## GKI 构建完成 ✅" >> $GITHUB_STEP_SUMMARY
          echo "架构: ${{ env.TARGET_ARCH }} | LTO: ${{ env.LTO_CONFIG }}" >> $GITHUB_STEP_SUMMARY

