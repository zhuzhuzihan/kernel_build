name: BlissOS 16 KernelSU Kernel Build (AOSP Clang)

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'Kernel branch to build'
        required: true
        default: 'hm/gloria'
        type: string
      kernel_version:
        description: 'Kernel version suffix'
        required: true
        default: '6.1.112'
        type: string
      build_kernelSU:
        description: 'Build with KernelSU'
        required: true
        default: true
        type: boolean
      upload_to_release:
        description: 'Upload to Release'
        required: false
        default: false
        type: boolean

env:
  KERNEL_BRANCH: ${{ github.event.inputs.kernel_branch || 'hm/gloria' }}
  KERNEL_VERSION: ${{ github.event.inputs.kernel_version || '6.1.112' }}
  KERNELSU: ${{ github.event.inputs.build_kernelSU || 'true' }}

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Free disk space
        run: |
          echo "=== 清理不需要的软件包以释放空间 ==="
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android/sdk
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /opt/hostedtoolcache/go
          sudo rm -rf /opt/hostedtoolcache/PyPy
          sudo rm -rf /opt/hostedtoolcache/Python
          sudo rm -rf /opt/hostedtoolcache/Ruby
          sudo rm -rf /opt/hostedtoolcache/node
          sudo rm -rf /opt/microsoft
          sudo rm -rf /opt/pipx
          sudo rm -rf /opt/google
          sudo rm -rf /opt/az
          
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          
          sudo apt-get remove -y \
            azure-cli \
            google-chrome-stable \
            firefox \
            microsoft-edge-stable \
            powershell \
            temurin-8-jdk \
            temurin-11-jdk \
            temurin-17-jdk \
            dotnet-sdk-* \
            mono-complete \
            2>/dev/null || true
          
          echo "=== 磁盘空间状态 ==="
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            bc \
            bison \
            flex \
            libelf-dev \
            libssl-dev \
            libncurses-dev \
            ccache \
            git \
            cpio \
            python3 \
            file \
            zstd \
            pahole \
            gcc \
            g++

      - name: Setup AOSP Clang toolchain
        run: |
          echo "=== 下载 AOSP Clang (稀疏克隆) ==="
          
          mkdir -p toolchain
          cd toolchain
          
          # 使用新版稀疏克隆方式
          git clone --filter=blob:none --sparse --depth=1 \
            --branch android-14.0.0_r75 \
            https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 \
            aosp-clang
          
          cd aosp-clang
          
          # 稀疏检出 clang-r510928 目录
          git sparse-checkout set clang-r510928
          
          # 设置环境变量
          CLANG_PATH="$(pwd)/clang-r510928/bin"
          echo "CLANG_PATH=$CLANG_PATH" >> $GITHUB_ENV
          echo "PATH=$CLANG_PATH:/usr/bin:$PATH" >> $GITHUB_ENV
          
          # 验证
          echo "=== Clang 版本 ==="
          clang --version

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: kernel-${{ env.KERNEL_BRANCH }}-aosp-clang
          max-size: 2G

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout kernel source
        run: |
          echo "=== 克隆内核源码 ==="
          git clone https://github.com/android-generic/kerNel_common.git -b ${{ env.KERNEL_BRANCH }} --depth=1 kernel
          cd kernel
          echo "内核版本: $(make kernelversion)"
          echo "分支: $(git branch --show-current)"
          echo "提交: $(git log -1 --oneline)"

      - name: Checkout kernel drivers
        run: |
          echo "=== 克隆内核驱动 ==="
          cd kernel
          git clone https://github.com/android-generic/external_kernel-drivers.git -b 6.1 drivers/external
          cd drivers/external
          
          git submodule update --init --recursive
          
          echo "已加载的外部驱动:"
          ls -la
          
          cat > Makefile << 'EOF'
          obj-$(CONFIG_BCM2079X) += bcm2079x_i2c_mod/
          obj-$(CONFIG_BROADCOM_WL) += broadcom-wl/
          obj-$(CONFIG_OPENRAZER) += openrazer/
          obj-$(CONFIG_RTL8188EU) += rtl8188eu/
          obj-$(CONFIG_RTL8188FU) += rtl8188fu/
          obj-$(CONFIG_RTL8188GU) += rtl8188gu/
          obj-$(CONFIG_RTL8723BU) += rtl8723bu/
          obj-$(CONFIG_RTL8723DU) += rtl8723du/
          obj-$(CONFIG_RTL8812AU) += rtl8812au/
          obj-$(CONFIG_RTL8821AU) += rtl8821au/
          obj-$(CONFIG_RTL8821CE) += rtl8821ce/
          obj-$(CONFIG_RTL8821CU) += rtl8821cu/
          obj-$(CONFIG_RTL88X2BU) += rtl88x2bu/
          obj-$(CONFIG_TP_SMAPI) += tp_smapi/
          obj-$(CONFIG_XPAD) += xpad/
          EOF
          
          if ! grep -q "external" ../Makefile; then
            echo "obj-y += external/" >> ../Makefile
            echo "已将 external 驱动添加到编译系统"
          fi

      - name: Setup KernelSU
        if: ${{ env.KERNELSU == 'true' }}
        run: |
          echo "=== 集成 ReSukiSU ==="
          cd kernel
          
          if [ -d "KernelSU" ]; then
            echo "删除原有的 KernelSU 文件夹"
            rm -rf KernelSU
          fi
          
          curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh" | bash
          
          if [ -d "drivers/kernelsu" ]; then
            echo "ReSukiSU 集成成功"
            ls -la drivers/kernelsu/
          else
            echo "ReSukiSU 集成失败"
            exit 1
          fi

      - name: Apply KernelSU patches
        if: ${{ env.KERNELSU == 'true' }}
        run: |
          echo "=== 应用 KernelSU 补丁 ==="
          cd kernel
          
          patch_file="${{ github.workspace }}/patch/patch.diff"
          echo "应用补丁: $patch_file"
          git apply --check "$patch_file" && git apply "$patch_file" || echo "补丁可能已应用或失败"
          
          echo "=== 补丁应用完成 ==="

      - name: Configure kernel
        run: |
          cd kernel
          
          make mrproper
          make CC=clang android-x86_64_defconfig
          
          if [ "${{ env.KERNELSU }}" = "true" ]; then
            ./scripts/config --enable CONFIG_KSU
            ./scripts/config --enable CONFIG_KSU_MANUAL_HOOK
          fi
          
          ./scripts/config --enable CONFIG_BCM2079X
          ./scripts/config --enable CONFIG_BROADCOM_WL
          ./scripts/config --enable CONFIG_OPENRAZER
          ./scripts/config --enable CONFIG_RTL8188EU
          ./scripts/config --enable CONFIG_RTL8188FU
          ./scripts/config --enable CONFIG_RTL8188GU
          ./scripts/config --enable CONFIG_RTL8723BU
          ./scripts/config --enable CONFIG_RTL8723DU
          ./scripts/config --enable CONFIG_RTL8812AU
          ./scripts/config --enable CONFIG_RTL8821AU
          ./scripts/config --enable CONFIG_RTL8821CE
          ./scripts/config --enable CONFIG_RTL8821CU
          ./scripts/config --enable CONFIG_RTL88X2BU
          ./scripts/config --enable CONFIG_TP_SMAPI
          ./scripts/config --enable CONFIG_XPAD
          
          # 自动接受所有新配置项的默认值，避免交互式提示
          make CC=clang olddefconfig
          
          echo "=== 内核配置完成 ==="

      - name: Build kernel
        run: |
          cd kernel
          
          export ARCH=x86_64
          export SUBARCH=x86_64
          export LOCALVERSION="-gloria-kernelsu"
          export CC=clang
          
          JOBS=$(nproc)
          echo "=== 开始编译内核 (使用 $JOBS 个核心) ==="
          echo "=== 使用 $(clang --version | head -1) ==="
          
          make -j${JOBS} 2>&1 | tee build.log
          
          echo "=== 编译完成 ==="

      - name: Prepare artifacts
        run: |
          cd kernel
          
          mkdir -p output
          
          cp arch/x86/boot/bzImage output/bzImage-${{ env.KERNEL_VERSION }}-gloria-kernelsu
          cp vmlinux output/vmlinux-${{ env.KERNEL_VERSION }}-gloria-kernelsu
          cp System.map output/System.map-${{ env.KERNEL_VERSION }}-gloria-kernelsu
          cp .config output/config-${{ env.KERNEL_VERSION }}-gloria-kernelsu
          cp build.log output/ 2>/dev/null || true
          
          echo "=== 安装内核模块 ==="
          mkdir -p /tmp/modules
          make INSTALL_MOD_PATH=/tmp/modules INSTALL_MOD_STRIP=1 modules_install
          
          echo "=== 打包内核模块 ==="
          cd /tmp/modules
          tar -czf ${{ github.workspace }}/kernel/output/kernel_modules-${{ env.KERNEL_VERSION }}.tar.gz .
          
          MODULE_COUNT=$(find /tmp/modules -name "*.ko" | wc -l)
          echo "已打包 $MODULE_COUNT 个内核模块"
          
          cd ${{ github.workspace }}/kernel
          
          echo "BlissOS 16 Kernel Build Info (AOSP Clang)" > output/build_info.txt
          echo "==========================" >> output/build_info.txt
          echo "Kernel Version: $(make kernelversion)" >> output/build_info.txt
          echo "Branch: ${{ env.KERNEL_BRANCH }}" >> output/build_info.txt
          echo "Commit: $(git log -1 --oneline)" >> output/build_info.txt
          echo "Build Date: $(date)" >> output/build_info.txt
          echo "KernelSU: ${{ env.KERNELSU }}" >> output/build_info.txt
          echo "Compiler: $(clang --version | head -1)" >> output/build_info.txt
          echo "Kernel Modules: $MODULE_COUNT" >> output/build_info.txt
          
          echo "=== 输出文件 ==="
          ls -la output/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: blissos-kernel-${{ env.KERNEL_VERSION }}-aosp-clang
          path: kernel/output/
          retention-days: 30

      - name: Create release
        if: ${{ github.event.inputs.upload_to_release == 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kernel-${{ env.KERNEL_VERSION }}-aosp-clang-${{ github.run_number }}
          name: BlissOS Kernel ${{ env.KERNEL_VERSION }} (AOSP Clang) - Build ${{ github.run_number }}
          body_path: kernel/output/build_info.txt
          files: kernel/output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post build summary
        run: |
          echo "## 构建完成 ✅ (AOSP Clang)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 项目 | 值 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| 内核版本 | ${{ env.KERNEL_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 分支 | ${{ env.KERNEL_BRANCH }} |" >> $GITHUB_STEP_SUMMARY
          echo "| KernelSU | ${{ env.KERNELSU }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 编译器 | AOSP Clang |" >> $GITHUB_STEP_SUMMARY
          echo "| 构建号 | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
